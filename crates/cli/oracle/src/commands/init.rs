use std::path::Path;

use colored::*;
use miden_client::Client;
use pm_accounts::oracle::OracleAccountBuilder;
use pm_utils_cli::{
    set_oracle_id, JsonStorage, ORACLE_ACCOUNT_COLUMN, PRAGMA_ACCOUNTS_STORAGE_FILE,
};
use serde_json::{self, json, Value};

#[derive(clap::Parser, Debug, Clone)]
#[clap(about = "Creates a new Oracle Account")]
pub struct InitCmd {}

impl InitCmd {
    pub async fn call(&self, client: &mut Client, network: &str) -> anyhow::Result<()> {
        println!("â³ Initiating the Oracle...\n");
        client.sync_state().await.unwrap();

        let (oracle_account, _) = OracleAccountBuilder::new()
            .with_client(client)
            .build()
            .await;
        let created_oracle_id = oracle_account.id();

        // Update the storage with the new oracle ID
        set_oracle_id(
            Path::new(PRAGMA_ACCOUNTS_STORAGE_FILE),
            network,
            &created_oracle_id,
        )?;
        println!();

        // Clear screen for better presentation
        print!("\x1B[2J\x1B[1;1H");

        println!(
            "{}",
            r#"
        ==============================================================
        â–—â–„â–„â–– â–—â–„â–„â––  â–—â–„â––  â–—â–„â–„â––â–—â––  â–—â–– â–—â–„â––     â–—â––  â–—â––â–—â–„â–„â–„â––â–—â–„â–„â–„ â–—â–„â–„â–„â––â–—â––  â–—â––
        â–â–Œ â–â–Œâ–â–Œ â–â–Œâ–â–Œ â–â–Œâ–â–Œ   â–â–›â–šâ–â–œâ–Œâ–â–Œ â–â–Œ    â–â–›â–šâ–â–œâ–Œ  â–ˆ  â–â–Œ  â–ˆâ–â–Œ   â–â–›â–šâ––â–â–Œ
        â–â–›â–€â–˜ â–â–›â–€â–šâ––â–â–›â–€â–œâ–Œâ–â–Œâ–â–œâ–Œâ–â–Œ  â–â–Œâ–â–›â–€â–œâ–Œ    â–â–Œ  â–â–Œ  â–ˆ  â–â–Œ  â–ˆâ–â–›â–€â–€â–˜â–â–Œ â–â–œâ–Œ
        â–â–Œ   â–â–Œ â–â–Œâ–â–Œ â–â–Œâ–â–šâ–„â–â–˜â–â–Œ  â–â–Œâ–â–Œ â–â–Œ    â–â–Œ  â–â–Œâ–—â–„â–ˆâ–„â––â–â–™â–„â–„â–€â–â–™â–„â–„â––â–â–Œ  â–â–Œ

        ==============================================================

        "#
            .bright_cyan()
        );

        println!(
            "{}",
            r#"
        ğŸŒŸ Welcome to the Pragma Oracle Network - Admin Console ğŸŒŸ
        "#
            .bright_yellow()
        );

        println!("\n{}", "ğŸ“ Oracle Details".bright_green());
        println!(
            "{}",
            format!(
                "
        â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ Oracle ID: {}
        â”‚ Storage Location: {}
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯",
                created_oracle_id.to_string().bright_white(),
                PRAGMA_ACCOUNTS_STORAGE_FILE.bright_white()
            )
            .bright_blue()
        );

        println!("\n{}", "ğŸ® Available Commands".bright_green());

        println!(
            "{}",
            r#"
        - Register New Publishers
        â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ pm-oracle-cli register-publisher [PUBLISHER_ID]            â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        "#
            .bright_blue()
        );

        println!(
            "{}",
            r#"
        - View Publisher Entries
        â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ pm-oracle-cli entry [PUBLISHER_ID] [PAIR]                  â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        "#
            .bright_blue()
        );

        println!(
            "{}",
            r#"
        - Calculate Median Price
        â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ pm-oracle-cli median [PAIR]                                â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        "#
            .bright_blue()
        );

        println!("{}", "ğŸ“‹ Example Usage".bright_yellow());
        println!(
            "{}",
            r#"
        â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ pm-oracle-cli register-publisher 0x64cbfe4bc88cfe00000556901757eb  â”‚
        â”‚ pm-oracle-cli entry 96310150000 BTC/USD                            â”‚
        â”‚ pm-oracle-cli median BTC/USD                                       â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        "#
            .bright_blue()
        );

        println!(
            "\n{}",
            "âœ¨ Your Oracle node is ready! Start managing your network! âœ¨".bright_green()
        );

        Ok(())
    }
}
